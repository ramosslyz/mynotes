# AWS Pentesting
## Naviagtion 
- **[[#S3 Buckets]]**
	- [[#what is S3]]
	- [[#AWS attack paths]]
	- [[#AWS Regions and Availability Zones]]
	- [[#Bucket policies and ACLs]]
	- [[#Bucket misconfigurations]]
	- [[#Scripts to find private buckets]]
	- [[#Discovering buckets with Grayhat Warfare]]
	- [[#Creating a local S3 lab]]
	- [[#Useful resource]]
- **[[#SSRF]]**
---
# S3 Buckets
## what is S3?
**S3 is a simple storage system** (as the name implies) and allows users to store data in the **cloud**. Just like how we store data on a file server, we can store data in what is known as an S3 bucket, which will hold the contents of our data. You can store copious amounts of data in these buckets and retrieve it any time you like.
### How is information stored?
**S3** stores your data in what's called an **object**, also known as **object storage**. Object storage allows you to store data such as pictures, videos, files, and any data associated with them in the form of an object.
### Using S3 buckets
S3 stores the following types of data:
- Pictures
- Videos
- Files
- Documents containing sensitive data,and so on

> **Important note** 
> *Remember, S3 is a local filesystem in the cloud*!

### S3 attributes
- S3 bucket names are **unique and cannot be the same as someone else's**. These names are specific to a particular bucket within a certain area (vuln -> *Bucket Takeover*)
- You can create up to 100 buckets.
- Buckets are **assigned by region**. It's important to remember what regions you store your buckets in – **that's how you access them.**
- Bucket naming rules -> [**Link**](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html) 

## AWS attack paths
- Scan the internet for public S3 buckets.
- Scan for common bucket names and finds a match.
- Scan for objects in the bucket.
-  Find matches and exfiltrates information.
## AWS Regions and Availability Zones
The storage of your data and the performance of the services depends on your region so make sure the closest region to you to minimize latency.You can look at the regions by selecting them in the top-right corner of the AWS console.

![[region.png]]
*The following screenshot was pulled directly from Amazon and
highlights all the regions and the local zones that you can select:*

![[allregions.png]]

### Availability Zones
Availability Zones are fantastic for minimizing redundancy and downtime if an EC2
Instance were to go offline. Availability Zones are created to allow you to distribute an
EC2 instance across multiple zones so that if your instance fails in one zone, it can still be
accessed in another.
This diagram illustrates how AWS utilizes
Availability Zones within each region:

![[aval.zones.png]]
## Bucket policies and ACLs
Bucket policies and **access control lists** (ACLs) are used for access control – acting as
the front line to allow and deny access to S3 resources in your AWS environment.
### Public bucket policies
Navigation: `Bucket Policy` -> `Policy Generator`

Policy Example:
```json
{
  "Id": "Policy1630945079819",
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "Stmt1630945075499",
      "Action": "s3:*",
      "Effect": "Allow",
      "Resource": "arn:aws:s3:::abuqasem",
      "Principal": "*"
    }
  ]
}
```
To get the bucket policy
```bash
aws s3api get-bucket-policy --bucket abuqasem

#For a readable output
aws s3api get-bucket-policy --bucket abuqasem --output text | jq
```
**Output**

![[s3api.png]]

### Understanding policy attributes
• **ID** : Used as a reference number.
• Version : Tells the users what version of the policy is being used.
• **Action** : This tells you what type of resource is being used. In our case we are using S3.
• **Effect** : This portion of the policy will either "deny" or "allow" access to the resource.
• **Resource** : ARN is placed here and tells the policy what resource the policy is being applied to.

### Private Bucket Policies
In this example we will  se `Effect` to `DENY`  to deny access to the s3 bucket.

Policy Example
```json
{
  "Id": "Policy1630948321031",
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "Stmt1630948319184",
      "Action": "s3:*",
      "Effect": "Deny",
      "Resource": "arn:aws:s3:::priv-abuqasem",
      "Principal": "*"
    }
  ]
}
```
### Uploading a new policy
Create a file with a Valid JSON and set the attributes you want then:
```bash 
aws s3api put-bucket-policy --bucket <BucketName> --policy file://<PolicyFile>.json
```
## Bucket misconfigurations
It's essential to look for simple and tiny details that could be used as leverage. S3 comes "preconditioned" with security in mind, meaning it is secured by default.These misconf. typically involve having misconfigured policies that allow too much access to a particular resource, or permissions that can easily be bypassed.

**To check whether there is any public access allowed to the bucket**
```bash
aws s3api get-public-access-block --bucket <BucketName>
```
**Output example**
In this case this Bucket is Public

![[Pentesting/AWS Pentesting/attachments/acl.png]]
## Scripts to find private buckets
### Python scripting
We need to install the Boto3 SDK for AWS. SDK is the acronym for **Software Development Kit**
> Important note
Boto3 is an AWS Software Development Kit (SDK) that is used for Python and allows developers to write code that can make use of services such as S3 and EC2.

Installation
```bash
pip3 install boto3
```
Example Code:
```python
import boto3
s3 = boto3.resource('s3')
my_bucket = s3.Bucket('my_bucket_name')
for object_summary in my_bucket.objects.filter(Prefix="dir_name/"):
	print(object_summary.key)
```
## Discovering buckets with Grayhat Warfare
A web-based tool [**Grayhat  Warfare**](https://buckets.grayhatwarfare.com/) allows users to find open buckets quickly with a simple query, and it also allows us to find other documents quickly by searching various file types.
## Creating a local S3 lab
MinIO is a local storage system that can be used to house data that you would want in the cloud and it is a great way to learn about S3 storage on your local network, without being restricted to only using names available in AWS. However, one of the drawbacks of MinIO is that policy setup can be a little bit of a learning curve or odd if you're used to typical policy generation with AWS.
> Important note
You can find a full walk-through on how to set up MinIO here:
https://medium.com/@jonathanchelmus/creating-an-
s3-lab-on-an-ec2-instance-95ffd8ac6c1 .

## Useful resource
- [**Must Read**] Tricks and tools: https://book.hacktricks.xyz/pentesting/pentesting-web/buckets/aws-s3

- More about boto3: https://realpython.com/python-boto3-aws-s3/


 # SSRF
https://blog.christophetd.fr/abusing-aws-metadata-service-using-ssrf-vulnerabilities/ 